name: Build Windows EXE

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # Install Flutter manually (works on ALL Windows runners)
    # -----------------------------
    - name: Download Flutter SDK
      run: |
        Invoke-WebRequest https://storage.googleapis.com/flutter_infra_release/releases/stable/windows/flutter_windows_3.24.5-stable.zip -OutFile flutter.zip
        Expand-Archive flutter.zip -DestinationPath $Env:UserProfile
        echo "$Env:UserProfile\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Check Flutter version
      run: flutter --version

    - name: Flutter Doctor
      run: flutter doctor -v

    # -----------------------------
    # Generate desktop project if missing
    # -----------------------------
    - name: Generate windows/ if missing
      run: |
        if (!(Test-Path "windows")) {
          Write-Host "⚠️ Missing windows/ folder — running flutter create"
          flutter create .
        } else {
          Write-Host "windows/ folder found"
        }

    # -----------------------------
    # Install dependencies
    # -----------------------------
    - name: Install packages
      run: flutter pub get

    # -----------------------------
    # Build EXE
    # -----------------------------
    - name: Build Windows Release
      run: flutter build windows --release

    # -----------------------------
    # Upload built files
    # -----------------------------
    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: henson-field-app-windows
        path: build/windows/x64/runner/Release/
